---
title: "Data preperation and Modeling"
author: "CHINDU"
output:
  pdf_document: default
  html_document: default
---
```{r}
library(tidytext)
library(dplyr)
tweet <- read.csv('Tweets.csv')
prop.table(table(tweet$airline_sentiment))

tweet$text <- gsub("^@\\w+ *", "", tweet$text)  # remove @airline
head(tweet)

# since unnest_tokens deal with punctuations and lowercase, we just need to worry about the other preprocessings requiried on the data,
library(tm)
tweet_data <- subset(tweet, airline_sentiment != 'neutral')
tweet_data <- subset(tweet_data, select=c('tweet_id','airline_sentiment', 'text','airline'))
tweet_data$text<-  gsub("\\W|\\d|http\\w?", " ", tweet_data$text, perl = T)
# Change special characters to english letters
library(stringi)
tweet_data$text<-stringi::stri_trans_general(tweet_data$text, "latin-ascii")
```

Lets understand how many tweets are there for each airline
```{r}
tweet_data %>% group_by(airline) %>%
  summarise(Total_tweets=n_distinct(tweet_id))
  
```

# Unnest token for further analysis
```{r}
tweet_data_token<- tweet_data%>%
  unnest_tokens(word,text)%>%
  anti_join(stop_words)
```  

# Checking the common words
```{r}
library(ggplot2)
word_count<-tweet_data_token %>%
  count(word,sort=TRUE)
word_count
```
```{r}
word_count %>%
  top_n(20) %>%
  mutate(word = reorder(word, n)) %>%
  # Use aes() to put words on the x-axis and frequency on the y-axis
  ggplot(aes(word, n)) +
  # Make a bar chart with geom_col()
  geom_col() +
  coord_flip()
```
The common words are flight, cancelled,service,customer,time,hours,hold etc.





```{r}

word_totals <- tweet_data_token %>%
  group_by (tweet_id) %>%
  count ()
```
```{r}
new<-tweet_data_token %>%
  inner_join(get_sentiments("bing")) %>%
  group_by (tweet_id) 
table(new$airline_sentiment,new$sentiment)
```

```{r}

word_counts <- tweet_data_token %>%
  # Implement sentiment analysis using the "bing" lexicon
  inner_join(get_sentiments("bing")) %>%
  # Count by word and sentiment
  count(word, sentiment)
```


Understanding the words that are influencing the sentiment score
```{r}
top_words <- word_counts %>%
  # Group by sentiment
  group_by(sentiment) %>%
  # Take the top 10 for each sentiment
  top_n(10) %>%
  ungroup() %>%
  # Make word a factor in order of n
  mutate(word = reorder(word, n))

# Use aes() to put words on the x-axis and n on the y-axis
ggplot(top_words, aes(word, n, fill = sentiment)) +
  # Make a bar chart with geom_col()
  geom_col(show.legend = FALSE) +
  facet_wrap(~sentiment, scales = "free") +  
  coord_flip() 

```

We should always check which words are contributing to the sentiment scores. Depending on the dataset it may not be what you want.

# comparison of positive and negarive reation by airline
```{r}
new %>%
    count(airline, sentiment) %>%
    group_by(sentiment) %>%
    top_n(10, n) %>%
    ungroup() %>%
    mutate(airline = reorder(airline, n)) %>%
    ggplot(aes(airline, n, fill = airline)) +
    geom_col(show.legend = FALSE) +
    facet_wrap(~ sentiment, scales = "free") +
    coord_flip()
```    

```{r}
new2 <- subset(new, select=c('airline','sentiment','word'))
```

Analyse top negatice words for each airline
```{r}

new2 %>%
    filter(sentiment == "negative") %>%
    count(word, airline) %>%
    group_by(airline) %>%
    top_n(10, n) %>%
    ungroup() %>%
    mutate(word = reorder(paste(word, airline, sep = "__"), n)) %>%
    ggplot(aes(word, n, fill = airline)) +
    geom_col(show.legend = FALSE) +
    scale_x_discrete(labels = function(x) gsub("__.+$", "", x)) +
    facet_wrap(~ airline, nrow = 2, scales = "free") +
    coord_flip()
```

here we can see some issue that we need to work on. Words like delayed and delays and delay means the same thing. We should group these together to get more meaningful analysis.

Lets look at the positive words for each airlines

```{r}
new2 %>%
    filter(sentiment == "positive") %>%
    count(word, airline) %>%
    group_by(airline) %>%
    top_n(10, n) %>%
    ungroup() %>%
    mutate(word = reorder(paste(word, airline, sep = "__"), n)) %>%
    ggplot(aes(word, n, fill = airline)) +
    geom_col(show.legend = FALSE) +
    scale_x_discrete(labels = function(x) gsub("__.+$", "", x)) +
    facet_wrap(~ airline, nrow = 2, scales = "free") +
    coord_flip()
```










```{r}
new2 %>%
    filter(sentiment == "negative") %>%
    count(word, airline) %>%
    group_by(airline) %>%
    top_n(10, n) 
```
```{r}
new<-tweet_data_token %>%
  inner_join(get_sentiments("afinn")) 


new2<-subset(new, select=c('tweet_id','value'))

new2 %>% 
  group_by (tweet_id) %>%
  summarise(sentiment=sum(value))
  



new$sentiment2<-ifelse(new2$value>0,"Positive","Negative")

table(new$airline_sentiment,new$sentiment2)
```










